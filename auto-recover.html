<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªåŠ¨æ¢å¤æ‹†ä¹¦åˆ†ææ•°æ®</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #991b1b 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .log {
      background: rgba(0,0,0,0.5);
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: monospace;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #22c55e;
    }
    .log-entry.error {
      border-left-color: #ef4444;
    }
    .log-entry.warning {
      border-left-color: #f59e0b;
    }
    .btn {
      background: linear-gradient(to right, #16a34a, #059669);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
      transition: transform 0.2s;
    }
    .btn:hover {
      transform: scale(1.05);
    }
    .btn.secondary {
      background: linear-gradient(to right, #6366f1, #8b5cf6);
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
    }
    .status.found {
      background: rgba(34, 197, 94, 0.2);
      border: 2px solid #22c55e;
    }
    .status.not-found {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”„ è‡ªåŠ¨æ¢å¤æ‹†ä¹¦åˆ†ææ•°æ®</h1>
    <div id="status" class="status">å‡†å¤‡å¼€å§‹...</div>
    <div id="log" class="log"></div>
    <div id="actions" style="text-align: center;"></div>
  </div>

  <script>
    const logDiv = document.getElementById('log');
    const statusDiv = document.getElementById('status');
    const actionsDiv = document.getElementById('actions');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function setStatus(text, found) {
      statusDiv.textContent = text;
      statusDiv.className = `status ${found ? 'found' : 'not-found'}`;
    }

    let recoveredData = {
      analysisResult: null,
      partialResults: null,
      importData: null
    };

    function recover() {
      log('å¼€å§‹è‡ªåŠ¨æ¢å¤æ‹†ä¹¦åˆ†ææ•°æ®...');
      let foundCount = 0;

      // æ£€æŸ¥ novel-editor-data
      try {
        const mainData = localStorage.getItem('novel-editor-data');
        if (mainData) {
          log('æ‰¾åˆ° novel-editor-dataï¼Œæ­£åœ¨è§£æ...');
          const parsed = JSON.parse(mainData);

          if (parsed.analysisResult) {
            recoveredData.analysisResult = parsed.analysisResult;
            log(`âœ“ æ‰¾åˆ° analysisResult (é•¿åº¦: ${JSON.stringify(parsed.analysisResult).length} å­—ç¬¦)`);
            foundCount++;
          } else {
            log('âœ— analysisResult ä¸å­˜åœ¨', 'warning');
          }

          if (parsed.partialResults && parsed.partialResults.length > 0) {
            recoveredData.partialResults = parsed.partialResults;
            log(`âœ“ æ‰¾åˆ° partialResults (${parsed.partialResults.length} é¡¹)`);
            foundCount++;
          } else {
            log('âœ— partialResults ä¸å­˜åœ¨æˆ–ä¸ºç©º', 'warning');
          }

          if (parsed.importData) {
            recoveredData.importData = parsed.importData;
            log(`âœ“ æ‰¾åˆ° importData`);
            foundCount++;
          } else {
            log('âœ— importData ä¸å­˜åœ¨', 'warning');
          }
        } else {
          log('âœ— novel-editor-data ä¸å­˜åœ¨', 'error');
        }
      } catch (e) {
        log(`è§£æ novel-editor-data å¤±è´¥: ${e.message}`, 'error');
      }

      // æ£€æŸ¥ç‹¬ç«‹é”®
      const independentKeys = ['analysisResult', 'partialResults', 'importData'];
      independentKeys.forEach(key => {
        try {
          const data = localStorage.getItem(key);
          if (data && !recoveredData[key]) {
            recoveredData[key] = JSON.parse(data);
            log(`âœ“ ä»ç‹¬ç«‹é”® ${key} æ‰¾åˆ°æ•°æ®`);
            foundCount++;
          }
        } catch (e) {
          log(`æ£€æŸ¥ ${key} å¤±è´¥: ${e.message}`, 'error');
        }
      });

      // æ˜¾ç¤ºç»“æœ
      if (foundCount > 0) {
        setStatus(`âœ“ æˆåŠŸæ‰¾åˆ° ${foundCount} é¡¹æ•°æ®ï¼`, true);
        showActions();
      } else {
        setStatus('âœ— æœªæ‰¾åˆ°ä»»ä½•æ‹†ä¹¦åˆ†ææ•°æ®', false);
        showNoDataActions();
      }

      log('æ¢å¤æ£€æŸ¥å®Œæˆ');
    }

    function showActions() {
      actionsDiv.innerHTML = `
        <button class="btn" onclick="exportAll()">ğŸ“¥ å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
        <button class="btn secondary" onclick="goToApp()">âœ… è¿”å›å†™ä½œåº”ç”¨</button>
      `;
    }

    function showNoDataActions() {
      actionsDiv.innerHTML = `
        <button class="btn secondary" onclick="goToApp()">âŒ è¿”å›å†™ä½œåº”ç”¨</button>
        <div style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.2); border-radius: 8px;">
          <strong>æ•°æ®ä¸¢å¤±å¯èƒ½çš„åŸå› ï¼š</strong>
          <ul style="text-align: left; margin-left: 30px;">
            <li>æ¸…é™¤äº†æµè§ˆå™¨ç¼“å­˜æˆ–Cookie</li>
            <li>ä½¿ç”¨äº†éšç§/æ— ç—•æ¨¡å¼</li>
            <li>æ›´æ¢äº†æµè§ˆå™¨æˆ–è®¾å¤‡</li>
            <li>æµè§ˆå™¨è‡ªåŠ¨æ¸…ç†äº†æ—§æ•°æ®</li>
          </ul>
        </div>
      `;
    }

    function exportAll() {
      log('å¼€å§‹å¯¼å‡ºæ‰€æœ‰æ¢å¤çš„æ•°æ®...');
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

      if (recoveredData.analysisResult) {
        downloadJSON(recoveredData.analysisResult, `analysisResult-${timestamp}.json`);
        log('âœ“ å·²å¯¼å‡º analysisResult');
      }

      if (recoveredData.partialResults) {
        downloadJSON(recoveredData.partialResults, `partialResults-${timestamp}.json`);
        log('âœ“ å·²å¯¼å‡º partialResults');
      }

      if (recoveredData.importData) {
        downloadJSON(recoveredData.importData, `importData-${timestamp}.json`);
        log('âœ“ å·²å¯¼å‡º importData');
      }

      // å¯¼å‡ºåˆå¹¶æ•°æ®
      downloadJSON(recoveredData, `all-recovered-data-${timestamp}.json`);
      log('âœ“ å·²å¯¼å‡ºåˆå¹¶çš„æ¢å¤æ•°æ®');

      log('å¯¼å‡ºå®Œæˆï¼');
    }

    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function goToApp() {
      window.location.href = '/';
    }

    // è‡ªåŠ¨å¼€å§‹æ¢å¤
    setTimeout(recover, 500);
  </script>
</body>
</html>
