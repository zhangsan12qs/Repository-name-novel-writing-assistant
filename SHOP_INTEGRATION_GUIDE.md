# 卡密销售与小说写作助手集成说明

## 项目结构

本项目由两个应用组成：

1. **卡密销售应用** (`/shop`) - 用于购买卡密
2. **小说写作助手** (`/`) - 用于写作，需要激活卡密后才能使用

## 功能说明

### 卡密销售应用 (/shop)

提供以下功能：
- 展示4种卡密套餐：试用卡、月卡、年卡、永久卡
- 模拟支付购买卡密
- 查看已购买的卡密列表
- 复制卡密

### 小说写作助手 (/)

提供以下功能：
- 完整的写作辅助功能
- 卡密验证激活
- 未激活时显示全屏验证界面，阻止使用

## 使用流程

### 1. 用户访问写小说应用

- 访问 `http://localhost:5000/`
- 如果未激活，会显示全屏验证界面
- 用户可以选择：
  - 输入已有的卡密进行激活
  - 点击"前往商店"按钮购买新卡密

### 2. 用户购买卡密

- 访问 `http://localhost:5000/shop`
- 选择合适的套餐
- 点击"立即购买"
- 确认订单信息
- 点击"去支付"
- 扫描二维码支付（微信/支付宝）
- 支付完成后点击"我已支付"
- 系统自动生成卡密并同步到 IndexedDB
- 复制生成的卡密

### 3. 用户激活卡密

- 返回写小说应用
- 输入卡密
- 点击"确认激活"

### 0. 开发者调试模式（仅供开发测试）

- 在强制验证界面底部，有一个"开发者调试模式"按钮
- 点击后会要求输入开发者密码
- 密码：jingmeng666（仅开发者知道）
- 输入正确密码后自动生成并激活永久卡密
- 显示生成的卡密供查看
- 此功能仅供开发者测试使用

**安全说明：**
- 只有知道开发者密码的人才能免费使用此功能
- 普通用户必须通过商店购买卡密
- 密码错误时会提示用户前往商店购买

**注意**：
1. 开发者调试模式生成的卡密价格为0，仅用于开发环境测试，生产环境应移除此功能。
2. 所有激活相关的数据存储在客户端的 IndexedDB 中，不依赖服务器端 API。
3. 卡密商店购买的卡密会自动同步到 IndexedDB，可直接激活。
4. 卡密商店功能（/shop）使用对象存储备份卡密数据，IndexedDB 用于激活验证。

### 2. 用户购买卡密

- 访问 `http://localhost:5000/shop`
- 选择合适的套餐
- 点击"立即购买"
- 完成模拟支付
- 系统生成卡密
- 复制生成的卡密

### 3. 用户激活卡密

- 返回写小说应用
- 输入卡密
- 点击"确认激活"
- 系统验证卡密有效性（调用 `/api/shop/verify`）
- 激活卡密到用户账户（调用 `/api/activation/verify`）
- 标记卡密为已使用（调用 `/api/shop/activate`）
- 激活成功，可以使用所有功能

## API接口

### 卡密销售应用API

#### POST /api/shop/purchase
购买卡密并保存到对象存储

**请求体：**
```json
{
  "keys": [
    {
      "code": "XXXX-XXXX-XXXX-XXXX",
      "type": "month",
      "duration": 30,
      "featureLevel": "basic",
      "price": 29.9,
      "status": "available",
      "createdAt": 1234567890
    }
  ],
  "totalPrice": 29.9
}
```

#### GET /api/shop/keys
获取已购买的卡密列表

**响应：**
```json
{
  "success": true,
  "keys": [...]
}
```

#### GET /api/shop/verify?code=XXXX-XXXX-XXXX-XXXX
验证卡密是否有效

**响应：**
```json
{
  "success": true,
  "key": {
    "code": "XXXX-XXXX-XXXX-XXXX",
    "type": "month",
    "duration": 30,
    "featureLevel": "basic"
  }
}
```

#### POST /api/shop/activate
标记卡密为已使用

**请求体：**
```json
{
  "code": "XXXX-XXXX-XXXX-XXXX",
  "userId": "user-123"
}
```

### 写小说应用API

#### POST /api/activation/verify
激活卡密到用户账户

**请求体：**
```json
{
  "code": "XXXX-XXXX-XXXX-XXXX",
  "userId": "user-123"
}
```

#### GET /api/activation/status?userId=xxx
获取用户激活状态

**响应：**
```json
{
  "success": true,
  "activation": {
    "isActive": true,
    "daysLeft": 29,
    "featureLevel": "basic"
  }
}
```

## 数据存储

### 卡密数据
存储在对象存储中，文件名：`card-keys-list.json`
格式：JSON数组，包含所有卡密信息

### 用户激活数据
存储在IndexedDB中
数据库名：`novel-activation-db`
表名：`userActivations`

## 卡密套餐说明

| 套餐 | 时长 | 价格 | 功能 |
|------|------|------|------|
| 试用卡 | 7天 | ¥9.9 | 基础写作功能 |
| 月卡 | 30天 | ¥29.9 | 所有试用功能 + 优先AI生成 |
| 年卡 | 1年 | ¥199.9 | 所有月卡功能 + 专业起名系统 |
| 永久卡 | 永久 | ¥599.9 | 所有年卡功能 + VIP专属功能 |

## 注意事项

1. **卡密安全**：卡密激活后无法重复使用，请妥善保管
2. **支付模拟**：当前使用模拟支付，实际使用需要接入真实支付系统
3. **数据共享**：卡密数据存储在对象存储中，两个应用共享同一数据源
4. **激活验证**：写小说应用会验证卡密有效性，未激活无法使用任何功能

## 部署说明

### 环境变量
确保以下环境变量已配置：
- `COZE_BUCKET_ENDPOINT_URL` - 对象存储端点
- `COZE_BUCKET_NAME` - 对象存储桶名

### 构建部署
```bash
pnpm build
pnpm start
```

### 开发模式
```bash
pnpm dev
```

## 扩展建议

1. **真实支付**：集成支付宝、微信支付等
2. **卡密管理后台**：添加管理员卡密管理界面
3. **订单系统**：记录购买历史和订单状态
4. **优惠券系统**：支持优惠券和折扣
5. **会员等级**：根据购买次数升级会员等级
